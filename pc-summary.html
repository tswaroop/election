{{ GRAMEX(cache=['parliament.csv']) }}{% code %}
from common import pc_setup
data, elections = DB.csv('parliament.csv', setup=pc_setup, dtype=object)
getarg = lambda v: args.get(v, [None])[0]
if getarg('STATE'):
    data = data[data['STATE'] == getarg('STATE')]
    elections = elections.reset_index()
    elections = elections[elections['STATE'] == getarg('STATE')].set_index(['YEAR', 'STATE', 'PC'])
if getarg('YEAR'):
    data = data[data['YEAR'] == getarg('YEAR')]
    elections = elections.reset_index()
    elections = elections[elections['YEAR'] == getarg('YEAR')].set_index(['YEAR', 'STATE', 'PC'])
{% end %}

{% if getarg('margin') %}
  {% set margin    = elections.sort('MARGIN'  , ascending=False).dropna(subset=['MARGIN'  ])[['WINNER', 'WINNING PARTY', '1', '2', 'MARGIN', 'MARGIN %']] %}
  {% set margin_pc = elections.sort('MARGIN %', ascending=False).dropna(subset=['MARGIN %'])[['WINNER', 'WINNING PARTY', '1', '2', 'MARGIN', 'MARGIN %']] %}
  {% if getarg('margin') == 'max' %}
    <h2>Highest margins</h2>
    {{ T('pc-table.html', table=margin.head(10), sort='MARGIN', remove='margin') }}
    <h2>Highest % margins</h2>
    {{ T('pc-table.html', table=margin_pc.head(10), sort='MARGIN %', remove='margin') }}
  {% elif getarg('margin') == 'min' %}
    <h2>Lowest margins</h2>
    {{ T('pc-table.html', table=margin.tail(10)[::-1], sort='MARGIN', decimals=3, remove='margin') }}
    <h2>Lowest % margins</h2>
    {{ T('pc-table.html', table=margin_pc.tail(10)[::-1], sort='MARGIN %', decimals=3, remove='margin') }}
  {% end %}

{% elif getarg('votes') %}
  {% set table = elections.sort('VOTES', ascending=False) %}
  {% if getarg('votes') == 'max' %}
    <h2>Most voters</h2>
    {{ T('pc-table.html', table=table[['VOTES', 'WINNER', 'WINNING PARTY']].dropna(subset=['VOTES']).head(20), sort='VOTES', remove='votes') }}
  {% elif getarg('votes') == 'min' %}
    <h2>Fewest voters</h2>
    {{ T('pc-table.html', table=table[table['VOTES'] > 0][['VOTES', 'WINNER', 'WINNING PARTY']].dropna(subset=['VOTES']).tail(20)[::-1], sort='VOTES', remove='votes') }}</pre>
  {% end %}

{% elif getarg('candidates') %}
  {% set table = elections.sort('CANDIDATES', ascending=False) %}
  {% if getarg('candidates') == 'max' %}
    <h2>Most candidates</h2>
    {{ T('pc-table.html', table=table[['CANDIDATES', 'WINNER', 'WINNING PARTY']].dropna(subset=['CANDIDATES']).head(20), sort='CANDIDATES', remove='candidates') }}
  {% elif getarg('candidates') == '1' %}
    <h2>All uncontested victories</h2>
    {{ T('pc-table.html', table=table[table['CANDIDATES'] == 1][['CANDIDATES', 'WINNER', 'WINNING PARTY']].dropna(subset=['CANDIDATES']), sort='CANDIDATES', remove='candidates') }}
  {% end %}

{% elif getarg('women') == 'max' %}
    <h2>Most WOMEN</h2>
    {% set table = elections.sort('WOMEN', ascending=False) %}
    {{ T('pc-table.html', table=table[['WOMEN', 'CANDIDATES', 'WOMEN %', 'WINNER', 'WINNING PARTY']].dropna(subset=['WOMEN']).head(10), sort='WOMEN', remove='women') }}
    <h2>Highest % of WOMEN</h2>
    {% set table = elections.sort('WOMEN %', ascending=False) %}
    {{ T('pc-table.html', table=table[['WOMEN', 'CANDIDATES', 'WOMEN %', 'WINNER', 'WINNING PARTY']].dropna(subset=['WOMEN %']).head(10), sort='WOMEN %', remove='women') }}

{% elif getarg('age') == 'max' %}
    {% set table = data.sort('AGE', ascending=False) %}
    <h2>Oldest candidates</h2>
    {{ T('pc-table.html', table=table[['YEAR', 'STATE', 'PC', 'NAME', 'PARTY', 'AGE', 'VOTES', '#']].set_index(['YEAR', 'STATE', 'PC']).dropna(subset=['AGE']).head(20), sort='AGE', remove='age') }}
{% else %}
    <h2>Not yet implemented</h2>
    <pre>{{ args }}</pre>

{% end %}
