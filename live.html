{{ GRAMEX(cache=['js/G.min.js', 'pc.csv', 'abbr.csv', 'colors.csv', 'style.css', '.head.html', '.tail.html', '2014-summary.json'], max_age=0) }}{% code %}
title = '2014 Counting Day'
description = 'A live update on the 2014 Indian Parliament elections, by Gramener.'

from urllib import quote

tv = args.get('tv')
appstyle = 'ibn' if 'ibnlive' in handler.request.host else ''
appstyle = args.get('style', [appstyle])[0]
pc = DB.csv('pc.csv')
abbr = DB.csv('abbr.csv').set_index(['Field', 'Name'])['Abbr'].ix['STATE']
abbr3 = DB.csv('abbr.csv').set_index(['Field', 'Name'])['Abbr3'].ix['STATE']
{% end %}<!DOCTYPE html><html lang="en">
<head>
  {{ T('.head.html', title=title, static_url=static_url, description=description, tv=tv, appstyle=appstyle) }}
</head><body class="{{ 'tv' if tv else ''}} first-time live">

{% if appstyle %}
  {{ T('header.' + appstyle + '.html') }}
{% end %}
<nav class="navbar navbar-default expressions" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand heading direct-link" href="?">
        <i class="glyphicon glyphicon-home"></i>
        Elections 2014
      </a>
    </div>
    <div class="collapse navbar-collapse" id="header-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a class="reload" href="?" title="Refresh" data-placement="bottom">
          At <span x-html="$.updated"></span>
          <i class="glyphicon glyphicon-refresh"></i>
        </a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container expressions">

  <div class="alert alert-danger" id="no-results">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
    <h4>Nothing to show</h4>
    <p>The combination of filters selected do not match any constituencies.</p>
    <p>
      <button type="button" class="back btn btn-default">Go back</button>
      <button type="button" class="clear-filter btn btn-success">Clear all filters</button>
    </p>
  </div>

  <script class="applied_filters onredraw" type="text/html">
    <div class="applied_filters">
      <% if (_.keys(applied_filters).length > 0) { %>
        <a href="?" title="Remove all filters" class="label label-danger">X</a>
      <% } %>
      <% _.each(applied_filters, function(val, key) { %>
        <a href="?<%= encodeURIComponent(key) %>="
          title="Remove <%= key %> filter"
          class="urlfilter label label-danger"
        ><%= key %>: <%= val.join(', ') %></a>
      <% }) %>
    </div>
  </script>

  <svg width="100%" height="45">
    <text class="alliance-name" x-text="$.alliances[0].name + ':' + ($.alliances[0].won + $.alliances[0].leading)" x-fill="$.alliances[0].color" dy="38" x="0%"></text>
    <text class="alliance-name other" x-text="$.alliances[1].name + ':' + ($.alliances[1].won + $.alliances[1].leading)" x-fill="$.alliances[1].color" dy="38" x="50%" text-anchor="middle"></text>
    <text class="alliance-name" x-text="$.alliances[2].name + ':' + ($.alliances[2].won + $.alliances[2].leading)" x-fill="$.alliances[2].color" dy="38" x="100%" text-anchor="end"></text>
  </svg>

  <div class="alliance-progress progress">
    {% for id in range(3) %}
      <div class="progress-bar"
        x-style="'background-color:' + $.alliances[{{ id }}].color + ';width:' + 100 * $.alliances[{{ id }}].won / $.constituencies.total + '%'"
        x-text="$.alliances[{{ id }}].won || ''"></div>
      <div class="progress-bar leading"
        x-style="'background-color:' + $.alliances[{{ id }}].color + ';width:' + 100 * $.alliances[{{ id }}].leading / $.constituencies.total + '%'"
        x-text="$.alliances[{{ id }}].leading || ''"></div>
      {% if id < 2 %}
        <div class="progress-bar leading" x-style="'background:none;width:' + alliance_progress_gap($, {{ id }}) + '%'"></div>
      {% end %}
    {% end %}
  </div>

  {% set barheight = 25 %}
  <svg width="100%" height="25">
    <text class="alliance-legend" x-html="$.alliances[0].name + ' won ' + $.alliances[0].won + ', leads in ' + $.alliances[0].leading" y="5" dy="1em"></text>
    <text class="alliance-legend" x-html="$.alliances[2].name + ' won ' + $.alliances[2].won + ', leads in ' + $.alliances[2].leading" y="5" dy="1em" x="100%" text-anchor="end"></text>
    <text class="alliance-legend" x="50%" y="23" text-anchor="middle" x-html="'Majority: ' + Math.ceil($.constituencies.total / 2) + ' / ' + $.constituencies.total"></text>
    <text x="50%" y="9" font-size="15" text-anchor="middle">&#x25b2;</text>
  </svg>

  <script class="parties onredraw" type="text/html">
    <div class="parties">
      <div class="row">
        {% for id in range(3) %}
          <div class="col-md-4">
            <% if (alliances[{{ id }}].parties.length) { %>
              <table class="table table-condensed party-summary">
                <thead>
                  <tr>
                    <th style="width:50px"><%= alliances[{{ id }}].name %></th>
                    <th style="width:30px">Won</th>
                    <th style="width:30px">Lead</th>
                    <th style="width:30px"></th>
                    <th style="width:100px"></th>
                  </tr>
                </thead>
                <tbody>
                  <% (alliances[{{ id }}].parties || []).forEach(function(party) { %>
                    <tr>
                      <td><%= party.name %></td>
                      <td><%= party.won %></td>
                      <td><%= party.leading %></td>
                      <td><%= party.all %></td>
                      <td>
                        <div class="progress">
                          <div class="progress-bar"         style="background-color:<%= party.color %>;width:<%= party.won / party_maxall * 100 %>%"></div>
                          <div class="progress-bar leading" style="background-color:<%= party.color %>;width:<%= party.leading / party_maxall * 100 %>%"></div>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            <% } %>
          </div>
        {% end %}
      </div>
    </div>
  </script>

  <div class="counting-progress progress">
    <div class="progress-bar" x-text="$.constituencies.finished + ' finished'"
      x-style="'background-color:{{ _color.brighten(_color.Office[0], -.5) }};width:' + $.constituencies.finished / $.constituencies.total * 100 + '%'"></div>
    <div class="progress-bar" x-text="$.constituencies.counting + ' counting'"
      x-style="'background-color:{{ _color.brighten(_color.Office[0], +.5) }};width:' + $.constituencies.counting / $.constituencies.total * 100 + '%'"></div>
    <div class="progress-bar" x-text="$.constituencies.awaited + ' awaited'"
      x-style="'background:none;color:#000;width:' + $.constituencies.awaited / $.constituencies.total * 100 + '%'"></div>
  </div>

  <script class="state-legend onredraw" type="text/html">
    <svg class="state-legend" width="100%" data-height="{{ 20./940 }}" viewBox="0 0 940 20">
      <% var w = 100. / (_.keys(states).length + 1), i=1 %>
      <rect class="urlfilter state-legend"
        href="?STATE="
        width="<%= w %>%"
        height="20"
        title="Clear State filter"
        fill="#e66"/>
      <text x="<%= .5 * w %>%" y="10" dy=".37em" text-anchor="middle" font-size="12">X</text>
      <% _.each(_.sortBy(states, function(i, state) { return state }), function(state) { %>
        <rect class="urlfilter state-legend"
          href="?STATE=<%= encodeURIComponent(state) %>"
          data-toggle="toggle"
          x="<%= w * i %>%"
          width="<%= w %>%"
          height="20"
          title="<%= state %>"
          fill="<%= q.STATE && q.STATE.indexOf(state) >= 0 ? '#ccf' : '#fff' %>"/>
        <text x="<%= (i + .5) * w %>%" y="10" dy=".37em" text-anchor="middle" font-size="12"><%= (tv ? abbr3 : abbr)[state] %></text>
      <% i++ %>
      <% }) %>
    </svg>
  </script>

  <div class="row">
    <div class="col-md-8">
      <div class="live-map"></div>
      <script class="live-summary" type="text/html">
        <div class="live-summary">
          <h2><%= result.length == 1 ? '1 constituency' : result.length + ' constituencies' %></h2>
          <% _.sortBy(result, function(row) { return row.PC.ST_ABBR + '-' + row.PC.PC_NAME }).forEach(function(row) { %>
            <div class="row">
              <div class="col-sm-4 right">
                <%= row.PC.PC_NAME %>, <%= row.PC.ST_ABBR %>
                <%        if (row.Status == 'Awaited' ) { %><i title="<%= row.Status %>" class="glyphicon glyphicon-remove"></i>
                <% } else if (row.Status == 'Counting') { %><i title="<%= row.Status %>" class="glyphicon glyphicon-time"></i>
                <% } else if (row.Status == 'Finished') { %><i title="<%= row.Status %>" class="glyphicon glyphicon-ok"></i>
                <% } %>
              </div>
              <div class="col-sm-8">
                <div class="progress">
                  <% _.filter(row.Result, function(v) { return v.votes }).slice(0, 6).forEach(function(v) { %>
                    <div class="progress-bar"
                         style="background-color:<%= colors[v.party] || colors.Other %>;width:<%= v['%'] * 100 %>%"
                         title="<%= v.name %> of <%= v.party %> has <%= _comma(v.votes) %> votes"
                    ><%= v.party %> <%= Math.round(100 * v['%']) %>%</div>
                  <% }) %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </script>
      <script class="consti-result" type="text/html">
        <div class="consti-result">
          <h2><%= pc.PC_NAME %>, <%= pc.ST_ABBR %></h2>
          <table class="table table-condensed">
            <tbody>
              <% for (var i=0, row; row=result[i]; i++) { %>
                <tr>
                  <td><%= row.name %></td>
                  <td style="background-color:<%= colors[row.party] || colors.Other %>">&#160;</td>
                  <td><a class="urlfilter" href="?2014-Party=<%= encodeURIComponent(row.party) %>"><%= row.party %></a></td>
                  <td><%= _comma(row.votes) %></td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </script>
      <div style="position:absolute;left:16px;top:0">
        <script class="onredraw" type="text/html">
          <div class="btn-group">
            <a class="urlfilter btn btn-default btn-sm <%= !q.color || q.color != 'party' ? 'active' : '' %>" href="?color=">Alliance</a>
            <a class="urlfilter btn btn-default btn-sm <%=  q.color && q.color == 'party' ? 'active' : '' %>" href="?color=party">Party</a>
          </div>
          <div class="btn-group">
            <a class="urlfilter btn btn-default btn-sm <%= !q.show || q.show == ''        ? 'active' : '' %>" href="?show=">Map</a>
            <a class="urlfilter btn btn-default btn-sm <%=  q.show && q.show == 'summary' ? 'active' : '' %>" href="?show=summary">Summary</a>
            <!-- a class="urlfilter btn btn-default btn-sm <%=  q.show && q.show == 'detail'  ? 'active' : '' %>" href="?show=detail">Detail</a -->
          </div>
        </script>
      </div>
    </div>
    <div class="col-md-4">
      <script class="onredraw" type="text/html">
        <% _.each(filters, function(vals, key) { %>
          <p class="btn-group">
            <a class="urlfilter btn btn-xs <%= key in applied_filters ? 'btn-success active' : 'btn-primary' %>"
               href="?<%= encodeURIComponent(key) %>="
               <% if (key in applied_filters) { %> title="Clear filter"<% } %>
            ><%= key.replace('-', ' ') %></a>
            <% _.each(vals, function(val) { %>
              <% var match = (key in applied_filters) && (applied_filters[key].indexOf(val) >= 0) %>
              <a class="urlfilter btn btn-xs <%= match ? 'btn-success active' : 'btn-default' %>"
                 data-toggle="toggle"
                 href="?<%= encodeURIComponent(key) %>=<%= encodeURIComponent(val) %>"><%= val %></a>
            <% }) %>
          </p>
        <% }) %>
      </script>
    </div>
  </div>

</div>

<script src="{{ static_url('/js/jquery2.min.js') }}"></script>
<script src="{{ static_url('/js/underscore-min.js') }}"></script>
<script src="{{ static_url('/js/bootstrap.v3.min.js') }}"></script>
<script src="{{ static_url('js/G.min.js') }}"></script>
<script>
var tv = {{ 1 if tv else 0 }}
var colors = {{ DB.csv('colors.csv')[['Name', 'Color']].drop_duplicates().set_index('Name')['Color'].to_json() }}
var data = {{ open('2014-summary.json').read() }}
var pcs = {{ pc.set_index('KEY').astype(str).to_json(orient='index') }}
var abbr = {{ abbr.to_json() }}
var abbr3 = {{ abbr3.to_json() }}
var candidates = []
var states
var filters = {
  '2014-Schedule' : ['07-Apr', '09-Apr', '10-Apr', '11-Apr', '12-Apr', '17-Apr', '24-Apr', '30-Apr', '07-May', '12-May'],
  'Hindi-speaking': ['Hindi', 'Rest'],
  'Bi-polar'      : ['Bi-polar', 'Rest'],
  'Rural'         : ['Rural', 'Semi Urban', 'Urban'],
  'SC'            : ['< 10%', '10-20%', '20-30%', '30%+'],
  'ST'            : ['< 10%', '10-30%', '30-50%', '50%+'],
  'Muslim'        : ['< 10%', '10-20%', '20-40%', '40%+'],
  '2009-Turnout'  : ['< 50%', '50-60%','60-70%', '70-80%', '80%+'],
  '2014-Turnout'  : ['< 50%', '50-60%','60-70%', '70-80%', '80%+'],
  '2009-Party'    : ['CONG', 'BJP', 'SP', 'BSP', 'JDU'],
  '2014-Party'    : ['CONG', 'BJP', 'SP', 'BSP', 'AAP'],
  '2014-Alliance' : ['NDA', 'UPA', 'OTHER'],
  '2009-Margin'   : ['< 2%', '2-5%', '5-10%', '10-20%', '20%+'],
  '2014-Margin'   : ['< 2%', '2-5%', '5-10%', '10-20%', '20%+'],
  'Swing'         : ['Anti-incumbent', 'Incumbent']
}

// Refresh PC information based on latest constituency-wise data
var statuses = ['Awaited', 'Counting', 'Finished']
var id_row
function process(data) {
  id_row = {}
  states = {}
  data.result = _.map(data.map, function(v) {
    var row = {
      ID: v[0],
      Party: v[1],
      Alliance: v[2],
      Votes: v[3],
      Status: statuses[v[4]],
      Result: v[5],
      PC: pcs[v[0]]
    }

    var pc = row.PC,
        candi = candidates[row.ID],
        result, votes, i, l, total, margin

    // Convert row.Result: votes into sorted {name:, party:, votes:, '%':}
    if (candi) {
      for (result=[], votes=row.Result, total=0, i=0, l=votes.length; i<l; i++) {
        result.push({name: candi[i][0], party: candi[i][1], votes: votes[i]})
        total += votes[i]
      }
      for (i=0, l=votes.length; i<l; i++) {
        result[i]['%'] = votes[i] / total
      }
      row.Result = _.sortBy(result, function(v) { return -v.votes })
      if (row.Result.length > 1) margin = (row.Result[0].votes - row.Result[1].votes) / total
    }

    // Update pcs for filtering
    pc['2014-Party'] = row.Party
    pc['2014-Alliance'] = row.Alliance
    pc['Status'] = row.Status
    pc['Swing'] = row.Party != pc['2009-Party'] ? 'Anti-incumbent' : 'Incumbent'
    pc['2014-Margin'] = margin < 0.02 ? '< 2%' :
                        margin < 0.05 ? '2-5%' :
                        margin < 0.10 ? '5-10%' :
                        margin < 0.20 ? '10-20%' : '20%+'
    id_row[row.ID] = row

    // Update states
    states[pc.STATE] = pc.STATE

    return row
  })
}
process(data)

// Load the map and store map_path['S01-01'] -> $path element
var map_path = {}
$('.live-map')
  .html('<br><h1>Loading constituency map...</h1>')
  .load('{{ static_url('pc-2014-4.svg') }}', function() {
    $('.live-map svg')
      .find('path')
        .attr('class', 'na')
        .each(function() {
          var $this = $(this)
          map_path[$this.attr('id')] = $this
        })
    redraw()
  })

// Load candidates' names
$.ajax({
  url: '2014-candidates.json',
  dataType: 'json',
  success: function(candidates) {
    window.candidates = candidates
    process(window.data)
  }
})

// Live rendering via x-attributes
var expr = []
$('.expressions')
  .find('*')
  .each(function() {
    var $el = $(this),
        xnames = []
    $.each(this.attributes, function() {
      if (this.name.match(/^x\-/)) {
        var attr = this.name.slice(2),
            calc = new Function('$', 'return ' + this.value),
            fn
        if (attr == 'text') fn = function(data) { return $el.text(calc(data)) }
        else if (attr == 'html') fn = function(data) { return $el.html(calc(data)) }
        else fn = function(data) { return $el.attr(attr, calc(data)) }
        expr.push(fn)
        xnames.push(this.name)
      }
    })
    $el.removeAttr(xnames.join(' '))
  })

// Used by .alliance-progress
function alliance_progress_gap(data, id) {
  var left = data.alliances[0].all  / data.constituencies.total,
      mid = data.alliances[1].all / data.constituencies.total,
      right = 1 - data.alliances[2].all  / data.constituencies.total,
      start = Math.max(left, .5 - mid / 2) ,
      end = start + mid
  return 100 * (id == 0 ? start - left : right - end)
}

// Filter based on query parameters
var _sort = function (dict) { return _.sortBy(_.values(dict), function(v) { return -v.all }) }
var _comma = function(x) { return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") }
function filter(data, q) {
  var result = [],
      status = {finished:0, counting:0, awaited:0, total:0},
      applied_filters = {},
      filters = [],
      alliances = {
        NDA:   { won:0, leading:0, all:0, name:'NDA',   color: colors.NDA  , parties:{} },
        UPA:   { won:0, leading:0, all:0, name:'UPA',   color: colors.UPA  , parties:{} },
        OTHER: { won:0, leading:0, all:0, name:'OTHER', color: colors.Other, parties:{} }
      },
      alliance, party, row, i, match

  _.each(q, function(val, key) {
    if (key in pcs['S01-1'] || key.match(/^(Party|Alliance|Status)$/)) {
      filters.push(function(pc) { return val.indexOf(pc[key]) >= 0 })
      applied_filters[key] = val
    }
  })

  for (i=0, row; row=data.result[i]; i++) {
    match = _.every(filters, function(fn) { return fn(row.PC) })
    if (!match) continue

    result.push(row)
    alliance = alliances[row.Alliance]
    party = alliance.parties[row.Party] = alliance.parties[row.Party] || { won:0, leading:0, all:0, name:row.Party, color: colors[row.Party] || colors['Other'] }

    status.total++
    if      (row.Status == 'Awaited' ) { status.awaited++; }
    else if (row.Status == 'Counting') { status.counting++; alliance.leading++; party.leading++; alliance.all++; party.all++; }
    else if (row.Status == 'Finished') { status.finished++; alliance.won++    ; party.won++    ; alliance.all++; party.all++; }
  }
  _.each(alliances, function(a) { a.parties = _sort(a.parties).slice(0, 5) })

  return result.length == 0 ? null : {
      alliances: alliances.NDA.all > alliances.UPA.all ? [alliances.NDA, alliances.OTHER, alliances.UPA] : [alliances.UPA, alliances.OTHER, alliances.NDA],
      party_maxall: _.max(_.map(alliances, function(a) { return _.max(_.pluck(a.parties, 'all')) } )),
      constituencies: status,
      updated: data.updated,
      applied_filters: applied_filters,
      q: q,
      result: result
    }
}

function redraw() {
  $('.tooltip').remove()
  var q = G.url.parse(location.href).searchList,
      subset = filter(data, q)

  _.each(map_path, function(val, key) { val.data('drawn', false) })
  if (subset) {
    subset.filters = filters
    $('script.onredraw').template(subset)
    expr.forEach(function(x) { x(subset) })

    var color_by = (q.color && q.color[0] == 'party') ? 'Party' : 'Alliance'
    if (q.show && q.show == 'summary') {
      $('script.live-summary').template(subset)
      $('div.live-summary').show()
      $('.live-map, .consti-result').hide()
    } else if (!q.show) {
      subset.result.forEach(function(row) {
        var path
        if (row.ID in map_path) {
          path = map_path[row.ID].data('drawn', true)
          if (row.Status == 'Awaited') {
            path.attr('class', 'na')
          } else if (row.Status == 'Counting') {
            path
              .attr('class', 'leading')
              .attr('fill', colors[row[color_by]] || '#a0a0a0')
              .attr('title', row.Party + ' (' + row.Alliance + ') is leading at ' + row.PC.PC_NAME + ' with ' + _comma(row.Votes) + ' votes')
          } else if (row.Status == 'Finished') {
            path
              .attr('class', '')
              .attr('fill', colors[row[color_by]] || '#a0a0a0')
              .attr('title', row.Party + ' (' + row.Alliance + ') won at ' + row.PC.PC_NAME + ' with ' + _comma(row.Votes) + ' votes')
          }
        }
      })
      $('.live-summary').hide()
      $('.live-map').show()
    }
    $(window).trigger('resize')
  } else {
    $('#no-results').show()
  }
  _.each(map_path, function(val, key) {
    if (!val.data('drawn'))
      val.attr('class', 'na')
  })
}
redraw()

function reload() {
  $.ajax({
    url: '2014-summary.json',
    dataType: 'json',
    success: function(data) {
      window.data = data
      process(data)
      redraw()
    },
    error: function() { console.log('error', arguments) }
  })

  {# ?refresh=5 for 5 minute auto-refresh #}
  {% if 'refresh' in args %}
    setTimeout(reload, {{ min(1, float(args['refresh'][0])) * 60000 }})
  {% end %}
}


$('body')
  .tooltip({
    selector: '[title]',
    html: true,
    container: 'body'
  })
  .aspect({
    selector: '[data-height]'
  })
  .urlfilter({
    selector: '.urlfilter',
    target: 'pushState'
  })
  .on('click', '.reload', function(e) {
    e.preventDefault()
    reload()
  })
  .on('loaded.g.urlfilter', function() {
    $(this).removeClass('first-time')
    redraw()
  })
  .on('click', '.back', function() { history.back() })
  .on('click', '.clear-filter', function() { history.pushState({}, '', 'live'); redraw() })
  .on('click', '#no-results .btn', function() { $('.alert').hide() })
  .on('click', '.live-map path', function(e) {
    var id = $(this).attr('id'),
        candi = candidates[id],
        row = id_row[id]
    if (candi && row) {
      $('script.consti-result').template({pc: pcs[id], result: _.filter(row.Result, function(v) { return v.votes }).slice(0, 5)})
      $('div.consti-result').show()
      e.stopPropagation()
    }
  })
  .on('click', '.live-map', function(e) {
    $('.consti-result').hide()
  })

$(window)
  .on('popstate', redraw)

</script>

{{ T('.tail.html', appstyle=appstyle) }}
</body></html>{#


Note about the filter() function.
---------------------------------
The output has the following structure
{
  updated: '11:34am',
  q: url_parameters,
  party_maxall: 86,     // Max won+leading across all parties
  constituencies: {
    awaited: 34,
    counting: 200,
    finished: 300,
    total: 534
  },
  alliances: [
      {
        "won":79,"leading":20,"all":99,"name":"UPA","color":"#2EA7FF",
        "parties":[
          {"won":72,"leading":17,"all":89,"name":"INC","color":"#2EA7FF"},
          {"won": 6,"leading": 2,"all": 8,"name":"NCP","color":"#2E3EEB"},
          ...
        ]
      },
      ...
  ],
  applied_filters: {
    key: [val1, val2, ...],
    ...
  },
  result: [
      {ID:..., Party:..., Alliance:..., Votes:..., Status:..., PC:..., Result: [{name:..., party:..., votes:...}]]
  ]
}
#}
