{{ GRAMEX(cache=['parliament.csv', 'colors.csv'], max_age=10*60) }}{% code %}
from urllib import quote
from common import pc_setup
data, elections = DB.csv('parliament.csv', setup=pc_setup, dtype=object)
data = data[data['PC'] == args['PC'][0]]
data = data[data['STATE'] == args['STATE'][0]]
data = data[data['YEAR'] == args['YEAR'][0]]
data.sort('VOTES', ascending=False, inplace=True)
columns = ['#', 'PARTY', 'NAME', 'VOTES', 'SEX', 'AGE', 'CATEGORY', ]
colors = DB.csv('colors.csv').set_index(['Field', 'Name'])['Color'].ix['PARTY']
N = int(args.get('n', [20])[0])
{% end %}
<h2><i class="back glyphicon glyphicon-circle-arrow-left"></i> {{ args['PC'][0].title() }}, {{ args['STATE'][0].title() }} {{ args['YEAR'][0] }} <small>{{ min(N, len(data)) }} / {{ len(data) }} candidates</small></h2>
<table class="table table-condensed analysis">
  <thead>
    {% for c in columns %}<th>{{ c }}</th>{% end %}
  </thead>
  <tbody>
    {% for i, row in data.head(N).iterrows() %}
      <tr>
        {% for c in columns %}
          {% if c in ('WINNER', 'NAME') %}
            <td>{{ escape(row[c].title()) }}</td>
          {% elif c in ('MARGIN', 'VOTES', '1', '2', 'WOMEN') %}
            <td>{{ 0 if pd.isnull(row[c]) else '{:,.0f}'.format(row[c]) }}</td>
          {% elif c.endswith('%') %}
            <td>{{ pc_format.format(0 if pd.isnull(row[c]) else row[c]) }}</td>
          {% elif c in ('CATEGORY', 'SEX') %}
            <td>{{ '' if pd.isnull(row[c]) else row[c] }}</td>
          {% elif c in ('AGE',) %}
            <td>{{ '' if pd.isnull(row[c]) else '{:,.0f}'.format(row[c]) }}</td>
          {% elif c in ('PARTY', ) %}
            {% set fill = colors.get(row[c], '#eee') %}
            <td style="background-color:{{ fill }};color:{{ _color.contrast(fill) }}">{{ row[c] }}</td>
          {% else %}
            <td>{{ row[c] }}</td>
          {% end %}
        {% end %}
      </tr>
    {% end %}
  </tbody>
</table>
