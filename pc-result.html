{{ GRAMEX(cache=['parliament.csv', 'colors.csv'], max_age=10*60) }}{% code %}
from urllib import quote
from common import pc_setup, NONE_COLOR
data, elections = DB.csv('parliament.csv', setup=pc_setup, dtype=object)
year = args.get('YEAR', ['2009'])[0]
try:
    noresult = False
    data = data[data['PC'] == args['PC'][0]]
    data = data[data['STATE'] == args['STATE'][0]]
    data = data[data['YEAR'] == year]
    data.sort('VOTES', ascending=False, inplace=True)
    result = elections.ix[year, args['STATE'][0], args['PC'][0]]
except KeyError:
    logging.error('KeyError: %s', handler.request.uri)
    noresult = True

columns = ['#', 'PARTY', 'NAME', 'VOTES', 'SEX', 'AGE', 'CATEGORY', ]
colors = DB.csv('colors.csv').set_index(['Field', 'Name'])['Color'].ix['PARTY']
N = int(args.get('n', [20])[0])
{% end %}
<div class="pc-result">
<h2>
  <div class="pull-right">
    <i class="glyphicon glyphicon-map-marker text-danger" href="cartogram?PC=" title="Cartogram"></i>
  </div>
  <i class="back glyphicon glyphicon-circle-arrow-left"></i>
  {{ args['PC'][0].title() }},
  <a href="state?PC=&YEAR=">{{ args['STATE'][0].title() }}</a>
  {{ year }}
  <small>{{ min(N, len(data)) }} / {{ len(data) }} candidates</small>
</h2>
{% if noresult %}
  <p>No results. Please try a <a href=".?STATE=&Y=">different option</a>.</p>
{% else %}
  <h3 class="winner-story">
    <span class="winner-name">{{ result['WINNER'] }}</span> of
    {% set fill = colors.get(result['PARTY'], NONE_COLOR) %}
    <span class="winner-party" style="background-color:{{ fill }};color:{{ _color.contrast(fill) }}">{{ result['PARTY'] }}</span> won by
    {{ '{:.1%} ({:,.0f} votes)'.format(result['MARGIN %'], result['MARGIN']) }}
    {% if len(data) > 1 %}
      {% set opponent = data.irow(1) %}
      against
      {{ opponent['NAME'] }} of
      {% set fill = colors.get(opponent['PARTY'], NONE_COLOR) %}
      <span class="winner-party" style="background-color:{{ fill }};color:{{ _color.contrast(fill) }}">{{ opponent['PARTY'] }}</span>.
    {% else %}
      uncontested.
    {% end %}
  </h3>

  <table class="table table-condensed analysis">
    <thead>
      {% for c in columns %}<th>{{ c }}</th>{% end %}
    </thead>
    <tbody>
      {% for i, row in data.head(N).iterrows() %}
        <tr>
          {% for c in columns %}
            {% if c in ('WINNER', 'NAME') %}
              <td>{{ escape(row[c].title()) }}</td>
            {% elif c in ('MARGIN', 'VOTES', '1', '2', 'WOMEN') %}
              <td>{{ 0 if pd.isnull(row[c]) else '{:,.0f}'.format(row[c]) }}</td>
            {% elif c.endswith('%') %}
              <td>{{ pc_format.format(0 if pd.isnull(row[c]) else row[c]) }}</td>
            {% elif c in ('CATEGORY', 'SEX') %}
              <td>{{ '' if pd.isnull(row[c]) else row[c] }}</td>
            {% elif c in ('AGE',) %}
              <td>{{ '' if pd.isnull(row[c]) else '{:,.0f}'.format(row[c]) }}</td>
            {% elif c in ('PARTY', ) %}
              {% set fill = colors.get(row[c], NONE_COLOR) %}
              <td style="background-color:{{ fill }};color:{{ _color.contrast(fill) }}">{{ row[c] }}</td>
            {% else %}
              <td>{{ row[c] }}</td>
            {% end %}
          {% end %}
        </tr>
      {% end %}
    </tbody>
  </table>
{% end %}
</div>
